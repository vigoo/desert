<!DOCTYPE html><html><head><title>desert: Codecs</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Daniel Vigovszky" /><meta name="description" content="A Scala binary serialization library" /><meta name="og:image" content="https://vigoo.github.io/desert/img/poster.png" /><meta name="image" property="og:image" content="https://vigoo.github.io/desert/img/poster.png" /><meta name="og:title" content="desert: Codecs" /><meta name="title" property="og:title" content="desert: Codecs" /><meta name="og:site_name" content="desert" /><meta name="og:url" content="https://vigoo.github.io/desert/" /><meta name="og:type" content="website" /><meta name="og:description" content="A Scala binary serialization library" /><link rel="icon" type="image/png" href="https://vigoo.github.io/desert/img/favicon.png" /><meta name="twitter:title" content="desert: Codecs" /><meta name="twitter:image" content="https://vigoo.github.io/desert/img/poster.png" /><meta name="twitter:description" content="A Scala binary serialization library" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:creator" content="@dvigovszky" /><link rel="icon" type="image/png" sizes="16x16" href="https://vigoo.github.io/desert/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="https://vigoo.github.io/desert/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="https://vigoo.github.io/desert/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="https://vigoo.github.io/desert/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="https://vigoo.github.io/desert/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="https://vigoo.github.io/desert/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="https://vigoo.github.io/desert/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="https://vigoo.github.io/desert/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="https://vigoo.github.io/desert/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="https://vigoo.github.io/desert/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="https://vigoo.github.io/desert/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="https://vigoo.github.io/desert/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="https://vigoo.github.io/desert/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="https://vigoo.github.io/desert/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="https://vigoo.github.io/desert/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="https://vigoo.github.io/desert/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="https://vigoo.github.io/desert/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="https://vigoo.github.io/desert/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="https://vigoo.github.io/desert/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="https://vigoo.github.io/desert/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="https://vigoo.github.io/desert/highlight/styles/vs.css" /><link rel="stylesheet" href="/desert/css/light-style.css" /><script async="async">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-56320875-2' , 'auto');
ga('send', 'pageview');
      </script></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/desert/" class="brand"><div class="brand-wrapper"></div><span>desert</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/desert/index" title="Home" class="">Home</a></div> <div class="sidebar-nav-item  "><a href="/desert/docs/" title="Getting started" class="">Getting started</a></div> <div class="sidebar-nav-item  "><a href="/desert/docs/input-output" title="Input/output" class="">Input/output</a></div> <div class="sidebar-nav-item active "><a href="/desert/docs/codecs" title="Codecs" class="active">Codecs</a></div> <div class="sidebar-nav-item  "><a href="/desert/docs/evolution" title="Evolution" class="">Evolution</a></div> <div class="sidebar-nav-item  "><a href="/desert/docs/type-registry" title="Type Registry" class="">Type Registry</a></div> <div class="sidebar-nav-item  "><a href="/desert/docs/zio" title="Integrations: ZIO" class="">Integrations: ZIO</a></div> <div class="sidebar-nav-item  "><a href="/desert/docs/cats" title="Integrations: Cats" class="">Integrations: Cats</a></div> <div class="sidebar-nav-item  "><a href="/desert/docs/cats-effect" title="Integrations: Cats Effect" class="">Integrations: Cats Effect</a></div> <div class="sidebar-nav-item  "><a href="/desert/docs/akka" title="Integrations: Akka" class="">Integrations: Akka</a></div> <div class="sidebar-nav-item  "><a href="/desert/docs/release-notes" title="Release notes" class="">Release notes</a></div> <div class="sidebar-nav-item  "><a href="/desert/api/io/github/vigoo/desert/" title="API reference" class="">API reference</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/vigoo/desert" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/vigoo/desert" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="vigoo" data-github-repo="desert"><div class="content-wrapper"><section><h1 id="codecs">Codecs</h1>

<p>A <code class="highlighter-rouge">BinaryCodec[T]</code> defines both the <em>serializer</em> and <em>deserializer</em> for a given type:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">BinaryCodec</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">BinarySerializer</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">with</span> <span class="nc">BinaryDeserializer</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
</code></pre></div></div>
<h3 id="primitive-types">Primitive types</h3>
<p>The <code class="highlighter-rouge">io.github.vigoo.desert.codecs</code> module defines a lot of implicit binary codecs for common types.</p>

<p>The following code examples demonstrate this and also shows how the binary representation looks like.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">io.github.vigoo.desert.</span><span class="o">{</span><span class="nc">BinaryCodec</span><span class="o">,</span> <span class="nc">TransientConstructor</span><span class="o">,</span> <span class="nc">TransientField</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">io.github.vigoo.desert.codecs._</span>
<span class="k">import</span> <span class="nn">io.github.vigoo.desert.syntax._</span>

<span class="k">val</span> <span class="nv">byte</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="mf">100.</span><span class="n">toByte</span><span class="o">)</span>
<span class="c1">// byte: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(100)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">short</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="mf">100.</span><span class="n">toShort</span><span class="o">)</span>
<span class="c1">// short: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(0, 100)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">int</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
<span class="c1">// int: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(0, 0, 0, 100)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">long</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="mi">100L</span><span class="o">)</span>
<span class="c1">// long: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(0, 0, 0, 0, 0, 0, 0, 100)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">float</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="mf">3.14</span><span class="o">.</span><span class="py">toFloat</span><span class="o">)</span>
<span class="c1">// float: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(64, 72, -11, -61)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">double</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="mf">3.14</span><span class="o">)</span>
<span class="c1">// double: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(64, 9, 30, -72, 81, -21, -123, 31)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">bool</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="c1">// bool: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(1)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">unit</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(())</span>
<span class="c1">// unit: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array()</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">str</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="s">"Hello"</span><span class="o">)</span>
<span class="c1">// str: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(10, 72, 101, 108, 108, 111)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">uuid</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nv">java</span><span class="o">.</span><span class="py">util</span><span class="o">.</span><span class="py">UUID</span><span class="o">.</span><span class="py">randomUUID</span><span class="o">())</span>
<span class="c1">// uuid: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(</span>
<span class="c1">//     -93,</span>
<span class="c1">//     21,</span>
<span class="c1">//     108,</span>
<span class="c1">//     -59,</span>
<span class="c1">//     65,</span>
<span class="c1">//     75,</span>
<span class="c1">//     74,</span>
<span class="c1">//     24,</span>
<span class="c1">//     -108,</span>
<span class="c1">//     59,</span>
<span class="c1">//     -96,</span>
<span class="c1">//     11,</span>
<span class="c1">//     -124,</span>
<span class="c1">//     -66,</span>
<span class="c1">//     -116,</span>
<span class="c1">//     93</span>
<span class="c1">//   )</span>
<span class="c1">// )</span>
</code></pre></div></div>

<h3 id="option-either-try-validation">Option, Either, Try, Validation</h3>
<p>Common types such as <code class="highlighter-rouge">Option</code> and <code class="highlighter-rouge">Either</code> are also supported out of the box. For <code class="highlighter-rouge">Try</code> it
also has a codec for arbitrary <code class="highlighter-rouge">Throwable</code> instances, although deserializing it does not recreate
the original throwable just a <code class="highlighter-rouge">PersistedThrowable</code> instance. In practice this is a much safer approach
than trying to recreate the same exception via reflection.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scala.collection.immutable.SortedSet</span>
<span class="k">import</span> <span class="nn">scala.util._</span>
<span class="k">import</span> <span class="nn">zio.NonEmptyChunk</span>
<span class="k">import</span> <span class="nn">zio.prelude.Validation</span>

<span class="k">val</span> <span class="nv">none</span> <span class="k">=</span> <span class="n">serializeToArray</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]](</span><span class="nc">None</span><span class="o">)</span>
<span class="c1">// none: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(0)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">some</span> <span class="k">=</span> <span class="n">serializeToArray</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]](</span><span class="nc">Some</span><span class="o">(</span><span class="mi">100</span><span class="o">))</span>
<span class="c1">// some: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(1, 0, 0, 0, 100)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">left</span> <span class="k">=</span> <span class="n">serializeToArray</span><span class="o">[</span><span class="kt">Either</span><span class="o">[</span><span class="kt">Boolean</span>, <span class="kt">Int</span><span class="o">]](</span><span class="nc">Left</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span>
<span class="c1">// left: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(0, 1)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">right</span> <span class="k">=</span> <span class="n">serializeToArray</span><span class="o">[</span><span class="kt">Either</span><span class="o">[</span><span class="kt">Boolean</span>, <span class="kt">Int</span><span class="o">]](</span><span class="nc">Right</span><span class="o">(</span><span class="mi">100</span><span class="o">))</span>
<span class="c1">// right: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(1, 0, 0, 0, 100)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">valid</span> <span class="k">=</span> <span class="n">serializeToArray</span><span class="o">[</span><span class="kt">Validation</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">]](</span><span class="nv">Validation</span><span class="o">.</span><span class="py">Success</span><span class="o">(</span><span class="mi">100</span><span class="o">))</span>
<span class="c1">// valid: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(1, 0, 0, 0, 100)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">invalid</span> <span class="k">=</span> <span class="n">serializeToArray</span><span class="o">[</span><span class="kt">Validation</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span><span class="o">]](</span><span class="nv">Validation</span><span class="o">.</span><span class="py">Failure</span><span class="o">(</span><span class="nc">NonEmptyChunk</span><span class="o">(</span><span class="s">"error"</span><span class="o">)))</span>
<span class="c1">// invalid: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(0, 2, 10, 101, 114, 114, 111, 114)</span>
<span class="c1">// )</span>
</code></pre></div></div>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">fail</span> <span class="k">=</span> <span class="n">serializeToArray</span><span class="o">[</span><span class="kt">Try</span><span class="o">[</span><span class="kt">Int</span><span class="o">]](</span><span class="nc">Failure</span><span class="o">(</span><span class="k">new</span> <span class="nc">RuntimeException</span><span class="o">(</span><span class="s">"Test exception"</span><span class="o">)))</span>
</code></pre></div></div>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">failDeser</span> <span class="k">=</span> <span class="nv">fail</span><span class="o">.</span><span class="py">flatMap</span><span class="o">(</span><span class="n">data</span> <span class="k">=&gt;</span> <span class="n">deserializeFromArray</span><span class="o">[</span><span class="kt">Try</span><span class="o">[</span><span class="kt">Int</span><span class="o">]](</span><span class="n">data</span><span class="o">))</span>
<span class="c1">// failDeser: Either[io.github.vigoo.desert.DesertFailure, Try[Int]] = Right(</span>
<span class="c1">//   value = Failure(</span>
<span class="c1">//     exception = PersistedThrowable(</span>
<span class="c1">//       className = "java.lang.RuntimeException",</span>
<span class="c1">//       message = "Test exception",</span>
<span class="c1">//       stackTrace = Array(</span>
<span class="c1">//         repl.MdocSession$App.&lt;init&gt;(codecs.md:83),</span>
<span class="c1">//         repl.MdocSession$.app(codecs.md:3),</span>
<span class="c1">//         mdoc.internal.document.DocumentBuilder$$doc$.$anonfun$build$2(DocumentBuilder.scala:89),</span>
<span class="c1">//         scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18),</span>
<span class="c1">//         scala.util.DynamicVariable.withValue(DynamicVariable.scala:59),</span>
<span class="c1">//         scala.Console$.withErr(Console.scala:193),</span>
<span class="c1">//         mdoc.internal.document.DocumentBuilder$$doc$.$anonfun$build$1(DocumentBuilder.scala:89),</span>
<span class="c1">//         scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18),</span>
<span class="c1">//         scala.util.DynamicVariable.withValue(DynamicVariable.scala:59),</span>
<span class="c1">//         scala.Console$.withOut(Console.scala:164),</span>
<span class="c1">//         mdoc.internal.document.DocumentBuilder$$doc$.build(DocumentBuilder.scala:88),</span>
<span class="c1">//         mdoc.internal.markdown.MarkdownBuilder$.buildDocument(MarkdownBuilder.scala:44),</span>
<span class="c1">//         mdoc.internal.markdown.Processor.processScalaInputs(Processor.scala:182),</span>
<span class="c1">//         mdoc.internal.markdown.Processor.processScalaInputs(Processor.scala:149),</span>
<span class="c1">//         mdoc.internal.markdown.Processor.processDocument(Processor.scala:49),</span>
<span class="c1">//         mdoc.internal.markdown.Markdown$.toMarkdown(Markdown.scala:131),</span>
<span class="c1">//         mdoc.internal.cli.MainOps.handleMarkdown(MainOps.scala:82),</span>
<span class="c1">//         mdoc.internal.cli.MainOps.handleFile(MainOps.scala:110),</span>
<span class="c1">//         mdoc.internal.cli.MainOps.$anonfun$generateCompleteSite$1(MainOps.scala:156),</span>
<span class="c1">//         scala.collection.LinearSeqOps.foldLeft(LinearSeq.scala:168),</span>
<span class="c1">//         scala.collection.LinearSeqOps.foldLeft$(LinearSeq.scala:164),</span>
<span class="c1">//         scala.collection.immutable.List.foldLeft(List.scala:79),</span>
<span class="c1">//         mdoc.internal.cli.MainOps.generateCompleteSite(MainOps.scala:155),</span>
<span class="c1">//         mdoc.internal.cli.MainOps.run(MainOps.scala:177),</span>
<span class="c1">//         mdoc.internal.cli.MainOps$.process(MainOps.scala:269),</span>
<span class="c1">//         mdoc.Main$.process(Main.scala:26),</span>
<span class="c1">//         mdoc.Main$.process(Main.scala:21),</span>
<span class="c1">//         mdoc.Main$.main(Main.scala:16),</span>
<span class="c1">//         mdoc.Main.main(Main.scala),</span>
<span class="c1">//         jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method),</span>
<span class="c1">//         jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62),</span>
<span class="c1">//         jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43),</span>
<span class="c1">//         java.lang.reflect.Method.invoke(Method.java:566),</span>
<span class="c1">//         sbt.Run.invokeMain(Run.scala:133),</span>
<span class="c1">// ...</span>
<span class="k">val</span> <span class="nv">success</span> <span class="k">=</span> <span class="n">serializeToArray</span><span class="o">[</span><span class="kt">Try</span><span class="o">[</span><span class="kt">Int</span><span class="o">]](</span><span class="nc">Success</span><span class="o">(</span><span class="mi">100</span><span class="o">))</span>
<span class="c1">// success: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(1, 0, 0, 0, 100)</span>
<span class="c1">// )</span>
</code></pre></div></div>

<h3 id="collections">Collections</h3>
<p>There is a generic <code class="highlighter-rouge">iterableCodec</code> that can be used to define implicit collection codecs based on
the Scala 2.13 collection API. For example this is how the <code class="highlighter-rouge">vectorCodec</code> is defined:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">implicit</span> <span class="k">def</span> <span class="nf">vectorCodec</span><span class="o">[</span><span class="kt">A</span> <span class="kt">:</span> <span class="kt">BinaryCodec</span><span class="o">]</span><span class="k">:</span> <span class="kt">BinaryCodec</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="n">iterableCodec</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">Vector</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span>
</code></pre></div></div>

<p>All these collection codecs have one of the two possible representation. If the size is known in advance
then it is the number of elements followed by all the items in iteration order, otherwise it is a flat
list of all the elements wrapped in <code class="highlighter-rouge">Option[T]</code>. <code class="highlighter-rouge">Vector</code> and <code class="highlighter-rouge">List</code> are good examples for the two:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">vec</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">Vector</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">))</span>
<span class="c1">// vec: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(8, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 3, 0, 0, 0, 4)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">lst</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">))</span>
<span class="c1">// lst: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(</span>
<span class="c1">//     1,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     1,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     2,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     3,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     4,</span>
<span class="c1">//     0</span>
<span class="c1">//   )</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>Other supported collection types in the <code class="highlighter-rouge">codecs</code> package:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">zio.NonEmptyChunk</span>
<span class="k">import</span> <span class="nn">zio.prelude.NonEmptyList</span>
<span class="k">import</span> <span class="nn">zio.prelude.ZSet</span>

<span class="k">val</span> <span class="nv">arr</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">))</span>
<span class="c1">// arr: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(8, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 3, 0, 0, 0, 4)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">set</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">Set</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">))</span>
<span class="c1">// set: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(8, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 3, 0, 0, 0, 4)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">sortedSet</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">SortedSet</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">))</span>
<span class="c1">// sortedSet: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(</span>
<span class="c1">//     1,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     1,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     2,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     3,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     4,</span>
<span class="c1">//     0</span>
<span class="c1">//   )</span>
<span class="c1">// )</span>

<span class="k">val</span> <span class="nv">nec</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">NonEmptyChunk</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">))</span>
<span class="c1">// nec: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(8, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 3, 0, 0, 0, 4)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">nel</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">NonEmptyList</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">))</span>
<span class="c1">// nel: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(</span>
<span class="c1">//     1,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     1,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     2,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     3,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     4,</span>
<span class="c1">//     0</span>
<span class="c1">//   )</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">nes</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">ZSet</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">))</span>
<span class="c1">// nes: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(</span>
<span class="c1">//     8,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     2,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     3,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     1,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     4,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     0,</span>
<span class="c1">//     1</span>
<span class="c1">//   )</span>
<span class="c1">// )</span>
</code></pre></div></div>

<h3 id="string-deduplication">String deduplication</h3>
<p>For strings the library have a simple deduplication system, without sacrificing any extra
bytes for cases when strings are not duplicate. In general, the strings are encoded by a variable length
int representing the length of the string in bytes, followed by its UTF-8 encoding. 
When deduplication is enabled, each serialized 
string gets an ID and if it is serialized once more in the same stream, a negative number in place of the 
length identifies it.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">twoStrings1</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="s">"Hello"</span><span class="o">,</span> <span class="s">"Hello"</span><span class="o">))</span>
<span class="c1">// twoStrings1: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(</span>
<span class="c1">//     1,</span>
<span class="c1">//     1,</span>
<span class="c1">//     10,</span>
<span class="c1">//     72,</span>
<span class="c1">//     101,</span>
<span class="c1">//     108,</span>
<span class="c1">//     108,</span>
<span class="c1">//     111,</span>
<span class="c1">//     1,</span>
<span class="c1">//     10,</span>
<span class="c1">//     72,</span>
<span class="c1">//     101,</span>
<span class="c1">//     108,</span>
<span class="c1">//     108,</span>
<span class="c1">//     111,</span>
<span class="c1">//     0</span>
<span class="c1">//   )</span>
<span class="c1">// )</span>

<span class="k">val</span> <span class="nv">twoStrings2</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="nc">DeduplicatedString</span><span class="o">(</span><span class="s">"Hello"</span><span class="o">),</span> <span class="nc">DeduplicatedString</span><span class="o">(</span><span class="s">"Hello"</span><span class="o">)))</span>
<span class="c1">// twoStrings2: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(1, 1, 10, 72, 101, 108, 108, 111, 1, 1, 0)</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>It is not turned on by default because it breaks backward compatibility when evolving data structures.
If a new string field is added, old versions of the application will skip it and would not assign the
same ID to the string if it is first seen.</p>

<p>It is enabled internally in desert for some cases, and can be used in <em>custom serializers</em> freely.</p>

<h3 id="tuples">Tuples</h3>
<p>The elements of tuples are serialized flat and the whole tuple gets prefixed by <code class="highlighter-rouge">0</code>, which makes them
compatible with simple <em>case classes</em>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">tup</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">((</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">))</span> 
<span class="c1">// tup: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(0, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 3)</span>
<span class="c1">// )</span>
</code></pre></div></div>

<h3 id="maps">Maps</h3>
<p><code class="highlighter-rouge">Map</code>, <code class="highlighter-rouge">SortedMap</code> and <code class="highlighter-rouge">NonEmptyMap</code> are just another <code class="highlighter-rouge">iterableCodec</code> built on top of the <em>tuple support</em>
for serializing an iteration of key-value pairs:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scala.collection.immutable.SortedMap</span>

<span class="k">val</span> <span class="nv">map</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span><span class="mi">1</span> <span class="o">-&gt;</span> <span class="s">"x"</span><span class="o">,</span> <span class="mi">2</span> <span class="o">-&gt;</span> <span class="s">"y"</span><span class="o">))</span>
<span class="c1">// map: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(4, 0, 0, 0, 0, 1, 2, 120, 0, 0, 0, 0, 2, 2, 121)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">sortedmap</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">SortedMap</span><span class="o">(</span><span class="mi">1</span> <span class="o">-&gt;</span> <span class="s">"x"</span><span class="o">,</span> <span class="mi">2</span> <span class="o">-&gt;</span> <span class="s">"y"</span><span class="o">))</span>
<span class="c1">// sortedmap: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(4, 0, 0, 0, 0, 1, 2, 120, 0, 0, 0, 0, 2, 2, 121)</span>
<span class="c1">// )</span>
</code></pre></div></div>

<h3 id="generic-codecs-for-adts">Generic codecs for ADTs</h3>
<p>There is a generic derivable codec for algebraic data types, with support for <a href="evolution">evolving the type</a>
during the lifecycle of the application.</p>

<p>For <em>case classes</em> the representation is the same as for tuples:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Point</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">z</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
<span class="k">object</span> <span class="nc">Point</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">codec</span><span class="k">:</span> <span class="kt">BinaryCodec</span><span class="o">[</span><span class="kt">Point</span><span class="o">]</span> <span class="k">=</span> <span class="nv">BinaryCodec</span><span class="o">.</span><span class="py">derive</span><span class="o">()</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">pt</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">Point</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">))</span>
<span class="c1">// pt: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(0, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 3)</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>Note the empty parameter list for <code class="highlighter-rouge">BinaryCodec.derive</code>. It is where the <strong>evolution steps</strong> are defined, 
explained on a <a href="evolution">separate section</a>. When it is empty the only additional storage cost is the
single <code class="highlighter-rouge">0</code> byte on the beginning, just like with tuples.</p>

<p>For <em>sum types</em> the codec is not automatically derived for all the constructors. This is by design, as the
evolution steps has to be specified one by one per constructor. Other than that it works the same way, 
with <code class="highlighter-rouge">derive</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Drink</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Beer</span><span class="o">(</span><span class="n">typ</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Drink</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Water</span> <span class="k">extends</span> <span class="nc">Drink</span>

<span class="k">object</span> <span class="nc">Drink</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">beerCodec</span><span class="k">:</span> <span class="kt">BinaryCodec</span><span class="o">[</span><span class="kt">Beer</span><span class="o">]</span> <span class="k">=</span> <span class="nv">BinaryCodec</span><span class="o">.</span><span class="py">derive</span><span class="o">()</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">waterCodec</span><span class="k">:</span> <span class="kt">BinaryCodec</span><span class="o">[</span><span class="kt">Water.</span><span class="k">type</span><span class="o">]</span> <span class="k">=</span> <span class="nv">BinaryCodec</span><span class="o">.</span><span class="py">derive</span><span class="o">()</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">codec</span><span class="k">:</span> <span class="kt">BinaryCodec</span><span class="o">[</span><span class="kt">Drink</span><span class="o">]</span> <span class="k">=</span> <span class="nv">BinaryCodec</span><span class="o">.</span><span class="py">derive</span><span class="o">()</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">a</span> <span class="k">=</span> <span class="n">serializeToArray</span><span class="o">[</span><span class="kt">Drink</span><span class="o">](</span><span class="nc">Beer</span><span class="o">(</span><span class="s">"X"</span><span class="o">))</span>
<span class="c1">// a: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(0, 0, 0, 2, 88)</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">b</span> <span class="k">=</span> <span class="n">serializeToArray</span><span class="o">[</span><span class="kt">Drink</span><span class="o">](</span><span class="nc">Water</span><span class="o">)</span>
<span class="c1">// b: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(0, 1, 0)</span>
<span class="c1">// )</span>
</code></pre></div></div>

<h3 id="transient-fields-in-generic-codecs">Transient fields in generic codecs</h3>
<p>It is possible to mark some fields of a <em>case class</em> as <strong>transient</strong>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Point2</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">z</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="nd">@TransientField</span><span class="o">(</span><span class="nc">None</span><span class="o">)</span> <span class="n">cachedDistance</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span>
<span class="k">object</span> <span class="nc">Point2</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">codec</span><span class="k">:</span> <span class="kt">BinaryCodec</span><span class="o">[</span><span class="kt">Point2</span><span class="o">]</span> <span class="k">=</span> <span class="nv">BinaryCodec</span><span class="o">.</span><span class="py">derive</span><span class="o">()</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">pt2</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">data</span> <span class="k">&lt;-</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">Point2</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="mf">3.7416</span><span class="o">)))</span>
  <span class="n">result</span> <span class="k">&lt;-</span> <span class="n">deserializeFromArray</span><span class="o">[</span><span class="kt">Point2</span><span class="o">](</span><span class="n">data</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">result</span>
<span class="c1">// pt2: Either[io.github.vigoo.desert.DesertFailure, Point2] = Right(</span>
<span class="c1">//   value = Point2(x = 1, y = 2, z = 3, cachedDistance = None)</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>Transient fields are not being serialized and they get a default value contained by the annotation
during deserialization. Note that the default value is not type checked during compilation, if
it does not match the field type it causes runtime error.</p>

<h3 id="transient-constructors-in-generic-codecs">Transient constructors in generic codecs</h3>
<p>It is possible to mark whole constructors as <strong>transient</strong>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Cases</span>
<span class="nd">@TransientConstructor</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Case1</span><span class="o">()</span> <span class="k">extends</span> <span class="nc">Cases</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Case2</span><span class="o">()</span> <span class="k">extends</span> <span class="nc">Cases</span>

<span class="k">object</span> <span class="nc">Cases</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">case2Codec</span><span class="k">:</span> <span class="kt">BinaryCodec</span><span class="o">[</span><span class="kt">Case2</span><span class="o">]</span> <span class="k">=</span> <span class="nv">BinaryCodec</span><span class="o">.</span><span class="py">derive</span><span class="o">()</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">codec</span><span class="k">:</span> <span class="kt">BinaryCodec</span><span class="o">[</span><span class="kt">Cases</span><span class="o">]</span> <span class="k">=</span> <span class="nv">BinaryCodec</span><span class="o">.</span><span class="py">derive</span><span class="o">()</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">cs1</span> <span class="k">=</span> <span class="n">serializeToArray</span><span class="o">[</span><span class="kt">Cases</span><span class="o">](</span><span class="nc">Case1</span><span class="o">())</span>
<span class="c1">// cs1: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Left(</span>
<span class="c1">//   value = SerializingTransientConstructor(name = "Case1")</span>
<span class="c1">// )</span>
<span class="k">val</span> <span class="nv">cs2</span> <span class="k">=</span> <span class="n">serializeToArray</span><span class="o">[</span><span class="kt">Cases</span><span class="o">](</span><span class="nc">Case2</span><span class="o">())</span>
<span class="c1">// cs2: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(0, 0, 0)</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>Transient constructors cannot be serialized. A common use case is for remote accessible actors where 
some actor messages are known to be local only. By marking them as transient they can hold non-serializable data
without breaking the serialization of the other, remote messages.</p>

<h3 id="generic-codecs-for-value-type-wrappers">Generic codecs for value type wrappers</h3>
<p>It is a good practice to use zero-cost value type wrappers around primitive types to represent
the intention in the type system. <code class="highlighter-rouge">desert</code> can derive binary codecs for these too:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">DocumentId</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span> <span class="c1">// extends AnyVal // extends AnyVal</span>
<span class="k">object</span> <span class="nc">DocumentId</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">codec</span><span class="k">:</span> <span class="kt">BinaryCodec</span><span class="o">[</span><span class="kt">DocumentId</span><span class="o">]</span> <span class="k">=</span> <span class="nv">BinaryCodec</span><span class="o">.</span><span class="py">deriveForWrapper</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">id</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">DocumentId</span><span class="o">(</span><span class="mi">100</span><span class="o">))</span>
<span class="c1">// id: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(0, 0, 0, 0, 0, 0, 0, 100)</span>
<span class="c1">// )</span>
</code></pre></div></div>

<h3 id="custom-codecs">Custom codecs</h3>
<p>The <em>serialization</em> is a monadic function:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">Ser</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
</code></pre></div></div>

<p>while the <em>deserialization</em> is</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">deserialize</span><span class="o">()</span><span class="k">:</span> <span class="kt">Deser</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
</code></pre></div></div>

<p>where</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="kt">Ser</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ReaderT</span><span class="o">[</span><span class="kt">StateT</span><span class="o">[</span><span class="kt">EitherT</span><span class="o">[</span><span class="kt">Eval</span>, <span class="kt">DesertFailure</span>, <span class="kt">*</span><span class="o">]</span>, <span class="kt">SerializerState</span>, <span class="kt">*</span><span class="o">]</span>, <span class="kt">SerializationEnv</span>, <span class="kt">T</span><span class="o">]</span>
<span class="k">type</span> <span class="kt">Deser</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ReaderT</span><span class="o">[</span><span class="kt">StateT</span><span class="o">[</span><span class="kt">EitherT</span><span class="o">[</span><span class="kt">Eval</span>, <span class="kt">DesertFailure</span>, <span class="kt">*</span><span class="o">]</span>, <span class="kt">SerializerState</span>, <span class="kt">*</span><span class="o">]</span>, <span class="kt">DeserializationEnv</span>, <span class="kt">T</span><span class="o">]</span>
</code></pre></div></div>

<p>With the <code class="highlighter-rouge">BinaryCodec.define</code> function it is possible to define a fully custom codec. In the following
example we define a data type capable of representing cyclic graphs via a mutable <code class="highlighter-rouge">next</code> field, and 
a custom codec for deserializing it. It also shows that built-in support for tracking <em>object references</em>
which is not used by the generic codecs but can be used in scenarios like this.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.instances.either._</span>

  <span class="k">class</span> <span class="nc">Node</span><span class="o">(</span><span class="k">val</span> <span class="nv">label</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
             <span class="k">var</span> <span class="n">next</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Node</span><span class="o">])</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="nf">toString</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> 
      <span class="n">next</span> <span class="k">match</span> <span class="o">{</span>
       <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="s">"&lt;$label -&gt; ${n.label}&gt;"</span>
       <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="s">"&lt;$label&gt;"</span>
      <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">object</span> <span class="nc">Node</span> <span class="o">{</span>
    <span class="k">implicit</span> <span class="k">def</span> <span class="nf">codec</span><span class="k">:</span> <span class="kt">BinaryCodec</span><span class="o">[</span><span class="kt">Node</span><span class="o">]</span> <span class="k">=</span> <span class="nv">BinaryCodec</span><span class="o">.</span><span class="py">define</span><span class="o">[</span><span class="kt">Node</span><span class="o">](</span>
      <span class="c1">// Serializer function</span>
      <span class="n">node</span> <span class="k">=&gt;</span> <span class="k">for</span> <span class="o">{</span>
        <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">write</span><span class="o">(</span><span class="nv">node</span><span class="o">.</span><span class="py">label</span><span class="o">)</span> <span class="c1">// write the label using the built-in string codec</span>
        <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">node</span><span class="o">.</span><span class="py">next</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="k">=&gt;</span>
            <span class="k">for</span> <span class="o">{</span>
              <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">write</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="c1">// next is defined (built-in boolean codec)</span>
              <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">storeRefOrObject</span><span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="c1">// store ref-id or serialize next</span>
            <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>
          <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span>
            <span class="nf">write</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span> <span class="c1">// next is undefined (built-in boolean codec)</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>
    <span class="o">)(</span><span class="k">for</span> <span class="o">{</span> <span class="c1">// Deserializer function</span>
      <span class="n">label</span> <span class="k">&lt;-</span> <span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]()</span>        <span class="c1">// read the label using the built-in string codec</span>
      <span class="n">result</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">(</span><span class="n">label</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span> <span class="c1">// create the new node</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">storeReadRef</span><span class="o">(</span><span class="n">result</span><span class="o">)</span>      <span class="c1">// store the node in the reference map</span>
      <span class="n">hasNext</span> <span class="k">&lt;-</span> <span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]()</span>     <span class="c1">// read if 'next' is defined</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">if</span> <span class="o">(</span><span class="n">hasNext</span> <span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Read next with reference-id support and mutate the result</span>
        <span class="n">readRefOrValue</span><span class="o">[</span><span class="kt">Node</span><span class="o">](</span><span class="n">storeReadReference</span> <span class="k">=</span> <span class="kc">false</span><span class="o">).</span><span class="py">map</span> <span class="o">{</span> <span class="n">value</span> <span class="k">=&gt;</span> <span class="nv">result</span><span class="o">.</span><span class="py">next</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="o">}</span>
      <span class="o">}</span> <span class="k">else</span> <span class="nf">finishDeserializerWith</span><span class="o">(())</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">result</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Root</span><span class="o">(</span><span class="n">node</span><span class="k">:</span> <span class="kt">Node</span><span class="o">)</span>
  <span class="k">object</span> <span class="nc">Root</span> <span class="o">{</span>
    <span class="k">implicit</span> <span class="k">val</span> <span class="nv">codec</span><span class="k">:</span> <span class="kt">BinaryCodec</span><span class="o">[</span><span class="kt">Root</span><span class="o">]</span> <span class="k">=</span> <span class="nv">BinaryCodec</span><span class="o">.</span><span class="py">define</span><span class="o">[</span><span class="kt">Root</span><span class="o">](</span>
      <span class="n">root</span> <span class="k">=&gt;</span> <span class="nf">storeRefOrObject</span><span class="o">(</span><span class="nv">root</span><span class="o">.</span><span class="py">node</span><span class="o">)</span>
    <span class="o">)(</span><span class="n">readRefOrValue</span><span class="o">[</span><span class="kt">Node</span><span class="o">](</span><span class="n">storeReadReference</span> <span class="k">=</span> <span class="kc">false</span><span class="o">).</span><span class="py">map</span><span class="o">(</span><span class="nv">Root</span><span class="o">.</span><span class="py">apply</span><span class="o">))</span>
  <span class="o">}</span>

<span class="k">val</span> <span class="nv">nodeA</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span>
<span class="c1">// nodeA: Node = &lt;a -&gt; a&gt;</span>
<span class="k">val</span> <span class="nv">nodeB</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span>
<span class="c1">// nodeB: Node = &lt;a -&gt; a&gt;</span>
<span class="k">val</span> <span class="nv">nodeC</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span>
<span class="c1">// nodeC: Node = &lt;a -&gt; a&gt;</span>
<span class="nv">nodeA</span><span class="o">.</span><span class="py">next</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">nodeB</span><span class="o">)</span>
<span class="nv">nodeB</span><span class="o">.</span><span class="py">next</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">nodeC</span><span class="o">)</span>
<span class="nv">nodeC</span><span class="o">.</span><span class="py">next</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">nodeA</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">result</span> <span class="k">=</span> <span class="nf">serializeToArray</span><span class="o">(</span><span class="nc">Root</span><span class="o">(</span><span class="n">nodeA</span><span class="o">))</span>
<span class="c1">// result: Either[io.github.vigoo.desert.DesertFailure, Array[Byte]] = Right(</span>
<span class="c1">//   value = Array(0, 2, 97, 1, 0, 2, 97, 1, 0, 2, 97, 1, 1)</span>
<span class="c1">// )</span>
</code></pre></div></div>
</section></div></div></div></div><script src="https://vigoo.github.io/desert/highlight/highlight.pack.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/sbt.min.js"></script><script src="https://vigoo.github.io/desert/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash','scala','sbt']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="https://vigoo.github.io/desert/js/search.js"></script><script src="/desert/js/docs.js"></script></body></html>